version: '3.8'

services:
  # 1. 왼쪽 방 (Receiver/Client)
  left-env:
    image: alpine:latest
    container_name: left-env
    privileged: true
    # [설정 자동화]
    # 1. 라우터(...:01)의 ARP 등록
    # 2. 오른쪽 네트워크(2.0/24)로 가는 길 라우터로 지정
    command: >
      sh -c "apk add --no-cache tcpdump iproute2 &&
             arp -s 172.20.1.10 02:00:00:00:00:01 &&
             ip route add 172.20.2.0/24 via 172.20.1.10 &&
             tail -f /dev/null"
    networks:
      xdp-left-net:
        ipv4_address: 172.20.1.2
        mac_address: 02:00:00:00:00:02

  # 2. 라우터 (XDP Node) - Assignment 4의 핵심
  xdp-router:
    image: pgb0908/xdp-dev:latest
    container_name: xdp-router
    privileged: true
    hostname: xdp-router
    
    # [Assignment 4 필수 설정] 커널 포워딩 활성화
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1

    volumes:
      - ./xdp:/xdp
      - /lib/modules:/lib/modules:ro
      - /usr/src:/usr/src:ro
      - /sys/kernel/debug:/sys/kernel/debug
    
    # [설정 자동화]
    # 1. BPF 파일시스템 마운트
    # 2. [중요] bpf_fib_lookup이 성공하려면 라우터가 양쪽 방의 MAC을 알고 있어야 함 (Neighbor Entry)
    command: >
      sh -c "/xdp-tutorial/entrypoint.sh"

    networks:
      xdp-left-net:
        ipv4_address: 172.20.1.10
        mac_address: 02:00:00:00:00:01
      xdp-right-net:
        ipv4_address: 172.20.2.10
        mac_address: 02:00:00:00:00:03

  # 3. 오른쪽 방 (Sender/Server)
  right-env:
    image: alpine:latest
    container_name: right-env
    privileged: true
    # [설정 자동화]
    # 1. 라우터(...:03)의 ARP 등록
    # 2. 왼쪽 네트워크(1.0/24)로 가는 길 라우터로 지정
    command: >
      sh -c "apk add --no-cache iputils iproute2 &&
             arp -s 172.20.2.10 02:00:00:00:00:03 &&
             ip route add 172.20.1.0/24 via 172.20.2.10 &&
             tail -f /dev/null"
    networks:
      xdp-right-net:
        ipv4_address: 172.20.2.2
        mac_address: 02:00:00:00:00:04

networks:
  xdp-left-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.1.0/24
  xdp-right-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.2.0/24
